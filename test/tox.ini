[tox]
envlist = py3

[testenv:py3]
allowlist_externals = docker
deps = -rrequirements.txt
passenv = CIPLATFORM
setenv =
    COLUMNS=80
    PY_COLORS=1
    BRANCH=master
    BRANCH=development
commands =  # Build the Docker image for testing depending on the architecture, fall back to 'local' if not set
            # This allows us to run the tests on the host architecture if not on CI
            docker buildx build --no-cache --load --platform={env:CIPLATFORM:local} --progress plain -f ../src/Dockerfile \
            --build-arg WEB_BRANCH={env:BRANCH} --build-arg CORE_BRANCH={env:BRANCH} --build-arg FTL_BRANCH={env:BRANCH} \
            -t pihole:CI_container --target final ../src/
            # run the tests
            # # Not using > 1 cores as it causes random issues with the emulated architectures
            pytest {posargs:-vv} ./tests/
